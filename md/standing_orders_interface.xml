<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Standing_Orders_Interface" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <cues>

    <cue name="Main" version="2">
      <actions>
        <debug_text text="'StandingOrders: Main'" chance="100" filter="scripts" />
        <set_value name="$sourceShipForCloning" exact="null" />
      </actions>
      <cues>
        <cue name="On_Reload" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'StandingOrders'" control="'Reloaded'" />
          </conditions>
          <actions>
            <debug_text text="'StandingOrders: On_Reload'" chance="100" filter="scripts" />
            <signal_cue_instantly cue="Reloaded" />
          </actions>
        </cue>

        <cue name="Reloaded" instantiate="true">
          <conditions>
            <event_cue_signalled />
            <event_game_loaded />
          </conditions>
          <actions>
            <debug_text text="'StandingOrders: Reloaded'"
              chance="100" filter="general" />
            <set_value name="$sourceShipForCloning" exact="null" />
          </actions>
        </cue>

        <cue name="On_Get_Actions" instantiate="true">
          <conditions>
            <event_cue_signalled cue="md.Interact_Menu_API.Get_Actions" />
            <debug_text text="'StandingOrders: Get_Actions invoked with param: %s'.[event.param]" chance="100" filter="scripts" />
            <debug_text text="'StandingOrders: Get_Actions invoked with object: %s'.[@event.param.$object]" chance="100" filter="scripts" />
            <check_value value="player.holomap.isopen" />
            <check_value value="event.param.$object? and @event.param.$object != null" />
            <debug_text text="'StandingOrders: Get_Actions invoked with object.class: %s'.[@event.param.$object.class]" chance="100"
              filter="scripts" />
            <check_value value="@event.param.$object.isclass.{class.ship}" />
            <check_value value="@event.param.$object.trueowner == faction.player" />
            <check_value value="@event.param.$object.isoperational" />
            <check_value value="@event.param.$object.iswreck" negate="true" />
          </conditions>
          <actions>
            <set_value name="$params" exact="event.param" />
            <set_value name="$args" exact="null" />
            <set_value name="$menuSection" exact="'interaction'" />
            <do_if value="@$params.$selectedplayerships.count gt 0">
              <set_value name="$menuSection" exact="'trade_orders'" />
            </do_if>
            <do_if value="@$sourceShipForCloning == null">
              <debug_text text="'StandingOrders: Updating interaction menu actions to add Source Selection'" chance="100"
                filter="scripts" />

              <signal_cue_instantly
                cue="md.Interact_Menu_API.Add_Action"
                param="table[
                  $id         = 'player_standing_orders_select_source',
                  $section    = $menuSection,
                  $text       = '[&#8734;]: %s'.[{1972092408, 10101}],
                  $mouseover  = '[%s]: %s'.[{1972092408, 1}, {1972092408, 10101}],
                  $icon       = 'menu_export',
                  $active     = true,
                  $callback   =  Process_Menu
                ]" />
            </do_if>
            <do_elseif value="@$sourceShipForCloning == @event.param.$object">
              <debug_text text="'StandingOrders: Updating interaction menu actions to add Deselect Source Selection'" chance="100"
                filter="scripts" />
              <signal_cue_instantly
                cue="md.Interact_Menu_API.Add_Action"
                param="table[
                  $id         = 'player_standing_orders_deselect_source',
                  $section    = $menuSection,
                  $text       = '[&#8734;]: %s'.[{1972092408, 10201}],
                  $mouseover  = '[%s]: %s'.[{1972092408, 1}, {1972092408, 10201}],
                  $icon       = 'menu_reset',
                  $active     = true,
                  $callback   =  Process_Menu
                ]" />
            </do_elseif>
            <do_else>
              <debug_text text="'StandingOrders: Source selected is different from current source. Can be a target for cloning.'" chance="100"
                filter="scripts" />
              <set_value name="$sourceFullName" exact="@$sourceShipForCloning.name + ' (' + @$sourceShipForCloning.idcode + ')'" />
              <signal_cue_instantly
                cue="md.Interact_Menu_API.Add_Action"
                param="table[
                  $id         = 'player_standing_orders_clone',
                  $section    = $menuSection,
                  $text       = '[&#8734;]: %s'.[{1972092408, 10301}.[@$sourceFullName]],
                  $mouseover  = '[%s]: %s'.[{1972092408, 1}, {1972092408, 10301}.[@$sourceFullName]],
                  $icon       = 'menu_import',
                  $active     = true,
                  $callback   =  Process_Menu
                ]" />
            </do_else>
          </actions>
        </cue>

        <cue name="Process_Menu" instantiate="true">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <debug_text text="'StandingOrders: Process_Menu invoked with param: %s'.[event.param]" chance="100" filter="scripts" />
            <set_value name="$args" exact="null" />
            <do_if value="@event.param.$id == 'player_standing_orders_select_source' or @event.param.$id == 'player_standing_orders_deselect_source'">
              <set_value name="$sourceShipForCloning" exact="null" />
              <debug_text text="'StandingOrders: Deselected source for cloning. Current source: %s'.[@$sourceShipForCloning]" chance="100"
                filter="scripts" />
              <set_value name="$args"
                exact="table[
                  $command            = if @event.param.$id == 'player_standing_orders_select_source' then 'mark_source' else 'unmark_source',
                  $source             = @event.param.$object,
                ]" />
            </do_if>
            <do_elseif value="@event.param.$id == 'player_standing_orders_clone'">
              <do_if value="@$sourceShipForCloning != null">
                <create_list name="$targetList" />
                <append_to_list name="$targetList" exact="@event.param.$object" />
                <do_if value="@$params.$selectedplayerships.count gt 0">
                  <do_for_each name="$ship" in="@$params.$selectedplayerships">
                    <do_if
                      value="@$ship != @event.param.$object and
                      @event.param.$object.isclass.{class.ship} and
                      @event.param.$object.trueowner == faction.player and
                      @event.param.$object.isoperational and
                      not @event.param.$object.iswreck">
                      <append_to_list name="$targetList" exact="@$ship" />
                    </do_if>
                  </do_for_each>
                </do_if>
                <set_value name="$args"
                  exact="table[
                    $command            = 'clone_orders',
                    $source             = @$sourceShipForCloning,
                    $targets            = $targetList,
                  ]" />
                <debug_text text="'StandingOrders: Prepared clone_orders with source: %s and target: %s'.[@$sourceShipForCloning, @event.param.$object]"
                  chance="100" filter="scripts" />
              </do_if>
            </do_elseif>
            <do_if value="$args != null">
              <do_if value="not player.entity.$StandingOrdersRequest?">
                <set_value name="player.entity.$StandingOrdersRequest" exact="[]" />
              </do_if>
              <append_to_list name="player.entity.$StandingOrdersRequest" exact="$args" />
              <debug_text
                text="'StandingOrders: Sending %s with args: %s'.[$args.$command, $args]"
                chance="100" filter="scripts" />
              <raise_lua_event name="'StandingOrders.Request'" />
            </do_if>
          </actions>
        </cue>

        <cue name="Process_Results" instantiate="true">
          <conditions>
            <event_ui_triggered screen="'StandingOrders'" control="'Response'" />
          </conditions>
          <actions>
            <debug_text text="'StandingOrders: Capture_Results invoked with data in $StandingOrdersResponse: %s'.[player.entity.$StandingOrdersResponse]"
              chance="100" filter="scripts" />
            <!--Look
            up the action by id to get the callback.-->
            <set_value name="$result" exact="@player.entity.$StandingOrdersResponse" />
            <debug_text text="'StandingOrders: Process_Results invoked with result: %s'.[$result]" chance="100" filter="scripts" />
            <do_if value="$result? and @$result != null">
              <debug_text text="'StandingOrders: last command %s result: %s'.[@$result.$command, $result]" chance="100" filter="scripts" />
              <do_if value="@$result.$command == 'mark_source' and @$result.$source != null">
                <do_if value="@$result.$result == 'success' and @$result.$source != null">
                  <set_holomap_target object="@$result.$source" instant="true" />
                  <set_value name="$sourceShipForCloning" exact="@$result.$source" />
                  <debug_text text="'StandingOrders: Marked source for cloning: %s'.[@$sourceShipForCloning]" chance="100" filter="scripts" />
                </do_if>
              </do_if>
              <do_elseif value="@$result.$command == 'unmark_source' and @$result.$source != null">
                <do_if value="@$result.$result == 'success'">
                  <set_value name="$sourceShipForCloning" exact="null" />
                  <debug_text text="'StandingOrders: Unmarked source for cloning. Current source: %s'.[@$sourceShipForCloning]" chance="100"
                    filter="scripts" />
                </do_if>
              </do_elseif>
            </do_if>
          </actions>
        </cue>
      </cues>
    </cue>
  </cues>
</mdscript>